<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.shop.petpal.mapper.ProductListMapper">
	
	<select id="listCategory" parameterType="Integer" resultType="map">
		SELECT categoryNum, categoryName, sortOrder, species
		FROM category
		WHERE parentCategory IS NULL
			AND species = #{species}
		ORDER BY sortOrder ASC
	</select>
	
	<select id="listSubCategory" parameterType="map" resultType="map">
		SELECT categoryNum, categoryName, parentCategory, sortOrder, species
		FROM category
		WHERE species = #{species}
			<if test="parentCategory != 0">
				AND parentCategory = #{parentCategory}
			</if>
			<if test="parentCategory == 0">
				AND parentCategory IS NULL
			</if>
    	ORDER BY sortOrder ASC
	</select>
	
	<!-- 신상품 -->
	<select id="listRecentProducts" parameterType="map" resultType="com.shop.petpal.domain.Product">
		SELECT p.productNum, productName, productClass, price, discountRate, discountAmount,
			thumbnail, species, brand, regDate, NVL(COUNT(rating), 0) reviewCount, NVL(AVG(rating), 0) rating
		FROM (
		    SELECT *
		            FROM (SELECT inner.*, ROWNUM rnum
		                FROM (
		                    SELECT p.*
		                    FROM product p
		                    <if test="categoryNum != 0">
								LEFT OUTER JOIN category c
		                        	ON p.categoryNum = c.categoryNum
							</if>
		                    WHERE TO_CHAR(regDate, 'YYYYMMDD') &gt;= ${baseDate}
		                    	AND productStatus = 1
		                        AND p.species = #{species}
		                        <if test="categoryNum != 0">
									AND c.parentCategory = #{categoryNum}
								</if>
		                    ORDER BY regDate DESC
		                ) inner
	               WHERE ROWNUM &lt;= #{endNum}
	           )
	           WHERE rnum &gt;= #{startNum}
		    ) p
		LEFT OUTER JOIN orderDetail od
		    ON p.productNum = od.productNum
		LEFT OUTER JOIN review r
		    ON od.orderDetailNum = r.orderDetailNum
		GROUP BY (p.productNum, productName, productClass, price, discountRate, discountAmount,
			thumbnail, species, brand, regDate)
	</select>
	
	<!-- 베스트 상품 -->
	<select id="listBestProducts" parameterType="map" resultType="com.shop.petpal.domain.Product">
		SELECT productNum, productName, productClass, price, discountRate, discountAmount, 
                    thumbnail, species, brand, regDate, sales, reviewCount, rating
		FROM (SELECT outter.*, ROWNUM rnum
		    FROM (SELECT p.productNum, productName, productClass, price, discountRate, discountAmount, 
                    thumbnail, p.species, brand, regDate, NVL(sales, 0) sales, 
                    NVL(reviewCount, 0) reviewCount, NVL(rating, 0) rating
		        FROM (SELECT od.productNum, NVL(COUNT(*), 0) sales,
		        		NVL(COUNT(rating), 0) reviewCount, NVL(AVG(rating), 0) rating
		            FROM orderDetail od
		            LEFT OUTER JOIN review r
		                ON od.productNum = r.productNum
		            GROUP BY od.productNum
		        ) inner
		        RIGHT OUTER JOIN product p
		            ON p.productNum = inner.productNum
		        <if test="categoryNum != 0">
                LEFT OUTER JOIN category c
                    ON p.categoryNum = c.categoryNum
		        </if>
		        WHERE p.species = #{species}
		        <if test="categoryNum != 0">
		        AND c.parentCategory = #{categoryNum}
		        </if>
		        ORDER BY sales DESC, rating DESC
		    ) outter WHERE ROWNUM &lt;= #{endNum}
		) WHERE rnum &gt;= #{startNum}
	</select>
</mapper>