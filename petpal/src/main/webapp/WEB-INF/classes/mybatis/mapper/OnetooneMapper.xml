<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.shop.petpal.mapper.OnetooneMapper">
	<select id="qnaSeq" resultType="Long">
		SELECT qna_seq.NEXTVAL FROM dual
	</select>

	<insert id="insertQna" parameterType="com.shop.petpal.domain.Onetoone">
		INSERT INTO qna(num, subject, content, regDate, isAnswered, memberNum, classNum)
		VALUES(#{num}, #{subject}, #{content}, SYSDATE, 0, #{memberNum}, #{classNum})
	</insert>
	
	<delete id="deleteQna" parameterType="Long">
		DELETE FROM qna WHERE num = #{num}
	</delete>
	
	<select id="dataCount" parameterType="map" resultType="Integer">
		SELECT NVL(COUNT(*), 0)
		FROM qna q
		JOIN member1 m ON q.memberNum = m.memberNum
	</select>
	
	<select id="listQna">
		SELECT q.num, q.subject, q.content, TO_CHAR(q.regDate, 'YYYY-MM-DD') regDate, q.isAnswered, q.classNum, qc.className, userName
		FROM qna q
		JOIN member1 m ON q.memberNum = m.memberNum
		JOIN member2 m2 ON m.memberNum = m2.memberNum
		JOIN quesClass qc ON q.classNum = qc.classNum
		ORDER BY num DESC
		OFFSET #{offset} ROWS FETCH FIRST #{size} ROWS ONLY
	</select>
	
	<select id="findById" parameterType="Long" resultType="com.shop.petpal.domain.Onetoone">
		SELECT q.num, q.subject, q.content, q.regDate, q.isAnswered, q.classNum, qc.className, q.memberNum, m2.userName,
        a.memberNum answerNum, q.ansSubject, q.ansContent, q.ansRegDate
		FROM qna q
		JOIN member1 m ON q.memberNum = m.memberNum
        JOIN member2 m2 ON m.memberNum = m2.memberNum
		LEFT OUTER JOIN member1 a ON q.answerNum = a.memberNum
        JOIN quesClass qc ON q.classNum = qc.classNum
		WHERE num = #{num}
	</select>
	
	<insert id="insertQnaFile" parameterType="com.shop.petpal.domain.Onetoone">
		INSERT INTO qnaFile(qnaFileNum, num, qnaFileName)
		VALUES (qnaFile_seq.NEXTVAL, #{num}, #{qnaFileName})	
	</insert>
	
	<select id="listQnaFile" parameterType="Long" resultType="com.shop.petpal.domain.Onetoone">
		SELECT qnaFileNum, num, qnaFileName
		FROM qnaFile
		WHERE num = #{num}
	</select>

	<delete id="deleteQnaFile" parameterType="map">
		DELETE FROM qnaFile WHERE ${field} = #{num}
	</delete>
</mapper>