<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.shop.petpal.mapper.MypageMapper2">
	
	<!-- mypoint -->
	<!-- 포인트 리스트 -->
	<select id="myPointList" parameterType="long"
		resultType="com.shop.petpal.domain.Mypage2">
		SELECT memberNum, regDate, classify, point, balance
		FROM
		userPoint
		WHERE memberNum = #{memberNum}
	</select>

	<!-- 페이징처리를 위한 데이터 갯수 -->
	<select id="pointDataCount" parameterType="long"
		resultType="Integer">
		SELECT NVL(COUNT(*), 0)
		FROM userPoint
		WHERE memberNum = #{memberNum}
	</select>

	<!-- 포인트 리스트 날짜 검색 -->
	<select id="myPointListPaged" parameterType="map"
		resultType="com.shop.petpal.domain.Mypage2">
		SELECT memberNum, TO_CHAR(regDate,'YYYY-MM-DD')regDate, classify, point, balance
		FROM userPoint
		WHERE memberNum = #{memberNum}
		<if test="startDate != null and endDate != null">
			AND regDate BETWEEN #{startDate} AND #{endDate}
		</if>
		ORDER BY regDate DESC
		OFFSET #{offset} ROWS FETCH FIRST #{size} ROWS ONLY
	</select>
	
	<!-- 포인트 총 금액 -->
	<select id="myTotalPoint" parameterType="long" resultType="Integer">
		SELECT BALANCE
		FROM userPoint
		WHERE regDate = (
    	SELECT MAX(regDate)
    	FROM userPoint
		)
		AND memberNum = #{memberNum}
	</select>


	<!-- mymodify -->
	<!-- 회원정보 찾기 -->
	<select id="findByMemberNum" parameterType="long" resultType="com.shop.petpal.domain.Member">
        SELECT TO_CHAR(birth,'YYYY-MM-DD')birth,address1,address2,tel,nickname,userName,postalcode 
        FROM member2
        WHERE memberNum = #{memberNum}
    </select>
	<select id="findByMemberEmail" parameterType="String" resultType="com.shop.petpal.domain.Member">
        SELECT * FROM member1
        WHERE email = #{email}
    </select>
	<!-- 회원정보 수정 Member의 도메인을 사용 -->
	<update id="updateMember" parameterType="com.shop.petpal.domain.Member">
		UPDATE member2
		SET 
			birth = #{birth},
			tel = #{tel},
			nickname = #{nickname},
			userName = #{userName}
		WHERE memberNum = #{memberNum}
	</update>
	
	<!-- 비밀번호 수정 -->
	<update id="updateMemberPassword" parameterType="com.shop.petpal.domain.Member">
   		UPDATE member1
    	SET password = #{password}
    	WHERE memberNum = #{memberNum}
	</update>
	
	
	
	<!-- myaddress -->
	<!-- 나의 배송지 리스트 -->
	<select id="selectAllList" parameterType="long" resultType="com.shop.petpal.domain.Mypage2">
		SELECT destNum,recipientName,defaultDest,tel,postalCode,address1,address2,note,memberNum
		FROM memberDest
		WHERE memberNum = #{memberNum}
	</select>
	
	<!-- 배송지 삭제 -->
	<delete id="deleteDest" parameterType="com.shop.petpal.domain.Mypage2">
		DELETE FROM memberDest
		WHERE memberNum = #{memberNum}
		AND
		destNum = #{destNum}
	</delete>	
	
	<!-- 배송지 추가 -->
	<insert id="insertDest" parameterType="com.shop.petpal.domain.Mypage2">
		INSERT INTO memberDest(destNum,recipientName,defaultDest,tel,
			postalCode,address1,address2,note,memberNum)
		VALUES(memberdest_seq.NEXTVAL,#{recipientName},#{defaultDest},#{tel},
			#{postalCode},#{address1},#{address2},#{note, jdbcType=VARCHAR},#{memberNum})
	</insert>
	
	<!-- 배송지 수정(모든 배송지 일반 배송지로 변경) -->
	<update id="updateDefaultDest" parameterType="long">
		UPDATE memberDest set defaultdest = 1
		WHERE memberNum = #{memberNum}
	</update>
	
	<!-- 배송지 수정 -->
	<update id="updateDest" parameterType="com.shop.petpal.domain.Mypage2">
        UPDATE memberDest
        SET recipientName = #{recipientName}, defaultDest = #{defaultDest}, tel = #{tel},
            postalCode = #{postalCode}, address1 = #{address1}, address2 = #{address2}, note = #{note, jdbcType=VARCHAR}
        WHERE memberNum = #{memberNum} AND destNum = #{destNum}
    </update>
    
    
    <!-- 나의 펫 -->
    <!-- 나의 쿠폰 리스트 -->
    <select id="selectMemberCoupon" parameterType="long" resultType="com.shop.petpal.domain.Mypage2">
    	SELECT m.couponNum,m.memberNum,TO_CHAR(m.regDate,'YYYY-MM-DD') AS regDate,state,validity,couponName,discountRate,minPayment
		FROM memberCoupon m
		JOIN Coupon c
		ON m.couponNum = c.couponNum
		WHERE memberNum = #{memberNum}
		ORDER BY m.regDate DESC
    </select>
	
	
	
	<!-- 나의 펫 -->
	<!-- 나의 펫 리스트 -->
	<select id="selectMemberPet" parameterType="long" resultType="com.shop.petpal.domain.Mypage2">
		SELECT p.petNum, p.petName, p.petPhoto, p.petBirth, p.petGender, p.petWeight,
           p.bodyShape, p.petRegNum, p.memberNum, p.breedNum, b.breedName,b.species
    		FROM Pet p
    		JOIN Breed b ON b.breedNum = p.breedNum
   			WHERE memberNum = #{memberNum}
	</select>
	
	<select id="selectBreed" resultType="com.shop.petpal.domain.Mypage2">
		SELECT breedNum,species,breedName
		FROM Breed
		WHERE species = #{species}
	</select>
	
	<!-- 펫 추가 -->
    <insert id="insertMemberPet" parameterType="com.shop.petpal.domain.Mypage2">
        INSERT INTO Pet(petNum, petName, petPhoto, petBirth, petGender,
            petWeight, bodyShape, petRegNum, memberNum, breedNum)
        VALUES (pet_seq.nextval, #{petName}, #{petPhoto, jdbcType=VARCHAR}, 
            #{petBirth, jdbcType=DATE}, #{petGender, jdbcType=INTEGER}, 
            #{petWeight, jdbcType=DOUBLE}, #{bodyShape, jdbcType=INTEGER}, 
            #{petRegNum, jdbcType=VARCHAR}, #{memberNum, jdbcType=INTEGER}, #{breedNum, jdbcType=INTEGER})
    </insert>
    
	<!-- 펫 수정 -->
	<update id="updateMemberPet" parameterType="com.shop.petpal.domain.Mypage2">
	    UPDATE MemberPet
	    SET petName = #{petName, jdbcType=VARCHAR},
	        <if test="petPhoto != null">petPhoto = #{petPhoto, jdbcType=VARCHAR},</if>
	        <if test="petBirth != null">petBirth = #{petBirth, jdbcType=DATE},</if>
	        <if test="petGender != null">petGender = #{petGender, jdbcType=INTEGER},</if>
	        <if test="petWeight != null">petWeight = #{petWeight, jdbcType=DOUBLE},</if>
	        <if test="bodyShape != null">bodyShape = #{bodyShape, jdbcType=INTEGER},</if>
	        <if test="petRegNum != null">petRegNum = #{petRegNum, jdbcType=VARCHAR},</if>
	        <if test="breedNum != null">breedNum = #{breedNum, jdbcType=INTEGER},</if>
	        <if test="species != null">species = #{species, jdbcType=INTEGER}</if>
	    WHERE petNum = #{petNum} AND memberNum = #{memberNum}
	</update>
	
	
</mapper>